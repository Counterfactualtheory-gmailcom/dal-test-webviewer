<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Service Canada AI Assistant ‚Äî Answer Viewer</title>

  <style>

/* ===============================
   SERVICE CANADA INTRO OVERLAY
=============================== */

#sc-intro {
  position: fixed;
  inset: 0;
  background: #f2f2f2;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 100000;
  opacity: 1;
  transition: opacity 0.4s ease;
}

#sc-intro.hidden {
  opacity: 0;
  pointer-events: none;
}

.sc-intro-card {
  max-width: 520px;
  background: #ffffff;
  border-radius: 12px;
  padding: 28px 32px;
  text-align: center;
  box-shadow: 0 8px 30px rgba(0,0,0,0.12);
}

.sc-intro-card h1 {
  margin-top: 0;
  margin-bottom: 12px;
  font-size: 22px;
  color: #d60000;
}

.sc-intro-text {
  font-size: 15px;
  line-height: 1.45;
  margin-bottom: 14px;
}

.sc-intro-sub {
  font-size: 14px;
  color: #555;
  margin-bottom: 22px;
}

#sc-intro-continue {
  width: 100%;
  padding: 12px;
  font-size: 16px;
  font-weight: 600;
  border: none;
  border-radius: 6px;
  background: #d60000;
  color: #fff;
  cursor: pointer;
}

#sc-intro-continue:hover {
  opacity: 0.9;
}

/* App hidden until intro is dismissed */
#app-root {
  display: none;
  opacity: 0;
  transition: opacity 0.4s ease;
}

#app-root.visible {
  display: block;
  opacity: 1;
}

/* === Service Canada header (matches DAL / McGill) === */
#header {
  width: 100%;
  text-align: center;
  margin-top: 4px;     /* ‚Üì adjust THIS to move header down */
  margin-bottom: 8px;  /* space before the input box */
}

#header .app-title {
  font-weight: 700;
  font-size: 18px;
  margin: 0;
}

#header .app-subtitle {
  font-size: 14px;
  color: #0f4079;
  margin: 2px 0 0 0;
}

    :root {
      --wrap: 900px;
      --pad: 16px;
      --border: #cccccc;
      --accent: #ff0000;           /* ‚úÖ Service Canada red */
      --text: #000000;
      --bg: #f2f2f2;               /* ‚úÖ Light grey background */
      --bg-page: #f2f2f2;
      --muted: #555555;
      --link: #0f4079;             /* ‚úÖ Matching ‚ÄúWrite in any language‚Äù blue */
      --link-visited: #002f5c;
    }

    html, body {
      margin: 0;
      padding: 0;
      background: var(--bg-page);
      color: var(--text);
      font: 16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      -webkit-text-size-adjust: 100%;
    }
    .wrap {
      max-width: var(--wrap);
      margin: 0 auto;
      padding: var(--pad);
    }

/* --- Center answer output box (same as McGill) --- */
#out {
  background-color: #ffffff !important;
  color: #000000 !important;

  border: 2px solid #ff0000;          /* üá®üá¶ Service Canada red */
  border-radius: 12px;
  padding: 18px;

  width: 93%;
  max-width: 540px;                   /* same as DAL */
  margin-left: auto;
  margin-right: auto;

  display: block;
  overflow-y: auto;
  box-sizing: border-box;

  box-shadow: 0 0 8px rgba(255, 0, 0, 0.25); /* red glow */
  position: relative;
  transform: none;
  text-align: left;
}

/* ‚úÖ DAL / McGill parity ‚Äî hide output until real content exists */
#out:empty {
  display: none;
}
    
    a {
      word-break: break-word;
      text-decoration: underline;
      color: var(--link);
    }
    a:visited { color: var(--link-visited); }
    a:hover, a:focus { opacity: 0.9; }

    #out, #out *:not(a) { color: var(--text) !important; }
    #out a { color: var(--link) !important; }
    #out a:visited { color: var(--link-visited) !important; }
    #out, #out * { background: transparent !important; }
    #out blockquote { color: var(--muted) !important; }
    #out table th, #out table td { border-color: var(--border) !important; }

/* üî• FIX FOR iOS CUT-OFF DESCENDERS (g, y, p, j, q, emoji, bullets) */
#out * {
  line-height: 1.4 !important;
  padding-bottom: 2px !important;
}
    
    pre, code { white-space: pre-wrap; word-break: break-word; }
    blockquote {
      margin: 0 0 1em 0;
      padding-left: 12px;
      border-left: 4px solid var(--accent);
      color: var(--muted);
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin: 0.5em 0;
    }
    th, td {
      border: 1px solid var(--border);
      padding: 8px;
      vertical-align: top;
    }
    h1, h2, h3 {
      margin-top: 1.2em;
      color: var(--accent);
    }
    .muted { opacity: 0.9; color: var(--muted); }
    .debug {
      font: 12px/1.4 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      white-space: pre-wrap;
      margin-top: 8px;
      color: var(--accent);
      display: none;
    }

#followup-box {
  position: relative;

  width: 93%;
  max-width: 480px;
  margin-top: 12px;

  margin-left: auto;
  margin-right: auto;

  padding: 12px;

  background: #ffffff;
  border-radius: 8px;
  border: 2px solid var(--accent);
  box-shadow: 0 0 6px rgba(255, 0, 0, 0.2);

  box-sizing: border-box;
}
    
/* --- Larger textarea (cleanest, safest) --- */
#followup-text {
  width: 100%;                /* fills followup-box width */
  min-height: 170px;
  padding: 14px;              /* ‚Üê increased from 10px */
  font-size: 16px;            /* ‚Üê slightly larger */
  border-radius: 6px;
  border: 1px solid #ccc;
  outline: none;
  resize: none;
  margin: 0;
  box-sizing: border-box;
  background-color: #f9f9f9;
  color: #000;
}
    
#followup-btn, #copy-btn {
    margin-top: 8px;
    width: 100%;
    padding: 10px;
    font-weight: 600;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    background: var(--accent);
    color: #fff;
    font-size: 17px;
    position: relative;    /* ensure no floating */
    left: 0;               /* FIX: reset accidental shifting */
    margin-left: 0;        /* FIX: ensure full centering */
}

    #copy-btn {
      background: #0f4079;  /* ‚úÖ Blue for bilingual ‚ÄúWrite in any language‚Äù continuity */
      color: #fff;
    }
    #copy-btn:hover, #followup-btn:hover { opacity: 0.9; }

    /* üîπ Animated dots */
    #loading {
      display: none;
      text-align: center;
      margin-top: 10px;
      font-weight: 600;
      color: var(--accent);
    }
    #loading span { animation: blink 1.4s infinite both; }
    #loading span:nth-child(2) { animation-delay: 0.2s; }
    #loading span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes blink { 0%,80%,100% { opacity: 0; } 40% { opacity: 1; } }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/linkifyjs@4.1.3/dist/linkify.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/linkifyjs@4.1.3/dist/linkify-html.min.js"></script>
  <script src="https://thunkable.github.io/webviewer-extension/thunkableWebviewerExtension.js"></script>
</head>

<body>

<!-- ===============================
     SERVICE CANADA ORIENTATION
=============================== -->
<div id="sc-intro">
  <div class="sc-intro-card">
    <h1>Service Canada AI Assistant</h1>

    <p class="sc-intro-text">
      This tool is not an official Government of Canada service.
      It provides responses based on verified, publicly available
      Service Canada information and does not make decisions,
      determine eligibility, or replace official guidance.
    </p>

    <p class="sc-intro-sub">
      Built using strict source controls to reduce errors and
      hallucinations found in generic AI tools.
    </p>

    <button id="sc-intro-continue">Continue</button>
  </div>
</div>

<!-- ‚¨áÔ∏è EXISTING APP STARTS HERE ‚¨áÔ∏è -->
  
<div id="app-root" class="wrap">

  <!-- App header (matches DAL / McGill) -->
  <div id="header" style="text-align:center; margin: 12px auto 14px;">
    <div class="app-title" style="font-weight:700; font-size:18px;">
      Service Canada AI Assistant
    </div>
    <div class="app-subtitle" style="font-size:14px; color:#0f4079;">
      Write in any language
    </div>
  </div>

  <!-- Answer output -->
 <div id="out"></div>

  <!-- Follow-up input -->
  <div id="followup-box" style="margin-top: 12px;">
    <textarea
      id="followup-text"
      placeholder="Tap & type your Service Canada question, issue, or concern here..."
    ></textarea>

    <button id="followup-btn">Submit</button>
    <button id="copy-btn">Copy Last Answer</button>

    <div id="loading">
      Answer coming<span>.</span><span>.</span><span>.</span>
    </div>
  </div>

  <!-- Debug (optional) -->
  <div id="dbg" class="debug"></div>

</div>

  <script>
    marked.setOptions({ gfm:true, breaks:true, mangle:false, headerIds:false });
    const outEl=document.getElementById('out');
    const dbgEl=document.getElementById('dbg');
    const showDebug=/[?&]debug=1\b/.test(location.search);
    const followupBtn=document.getElementById('followup-btn');
    const followupText=document.getElementById('followup-text');
    const copyBtn=document.getElementById('copy-btn');

const isMobile =
  /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

if (copyBtn) {
  copyBtn.style.display = isMobile ? 'block' : 'none';
}
    
    const loading=document.getElementById('loading');
    let linkHandlerAttached=false;
    let lastAnswer="";
    let lastSingleAnswer = "";
    window.lastQuestion = "";

    function debug(m){if(!showDebug)return;dbgEl.style.display='block';dbgEl.textContent+=(dbgEl.textContent?'\n':'')+m;}

function safeRender(md){
  if (String(md).trim() === 'ready') return;
  const raw = String(md || '');

  // ‚úÖ Strip control tags from scaffolded answers
  const cleaned = raw

 // üî• REMOVE internal link-control directives (SC-only bug)
  .replace(/^OPEN_IN_BROWSER::.*$/gmi, '')
  .replace(/^OPEN_LINK::.*$/gmi, '')
    
    .replace(/<+START\s*ANSWER[^>]*>+/gi, '')   // <<START ANSWER>> and variants
    .replace(/<+END\s*ANSWER[^>]*>+/gi, '')     // <<END ANSWER>> and variants
    .replace(/\[+COMPLETED+\]/gi, '')           // [COMPLETED]
    .replace(/\[+DONE+\]/gi, '')                // [DONE]
    .trim();

  // ‚úÖ Render cleaned Markdown
  const html = marked.parse(cleaned || '');
  const clean1 = DOMPurify.sanitize(html, { ADD_ATTR: ['target','rel'] });

  let linked = clean1;
  try {
    if (typeof linkifyHtml === 'function') {
      linked = linkifyHtml(clean1, {
        defaultProtocol: 'https',
        nl2br: false,
        validate: { url: (v) => /^https?:\/\//i.test(v) },
        attributes: { rel: 'noopener', target: '_blank' }
      });
    }
  } catch (e) {
    debug('linkify error:' + e);
  }

const clean2 = DOMPurify.sanitize(linked, { ADD_ATTR: ['target','rel'] });
lastSingleAnswer = clean2;

// Append into the output box
if (outEl.textContent.includes('Waiting for content')) outEl.innerHTML = '';
outEl.innerHTML += (outEl.innerHTML ? '<hr>' : '') + clean2;
  
  /* -----------------------------------------------------------
     DAL‚ÄìMcGill DOM REFRESH BLOCK ‚Äî triggers reflow & wake-up
  ----------------------------------------------------------- */
  function removeEmptyBullets() {
    const lists = document.querySelectorAll("ul, ol");
    lists.forEach(list => {
      const items = list.querySelectorAll("li");
      items.forEach(li => {
        if (!li.textContent.trim()) li.remove();
      });
      if (!list.textContent.trim()) list.remove();
    });
  }
  removeEmptyBullets();
  /* ----------------------------------------------------------- */
  
  // ‚úÖ Normalize all links
  outEl.querySelectorAll('a').forEach(a => {
    a.target = '_blank';
    a.rel = 'noopener';
  });
}
    let firstMessageReceived=false;let readyPingerId=null;

// ‚úÖ FIX: Align Service Canada render timing with McGill/DAL (prevents tag bleed)
ThunkableWebviewerExtension.receiveMessage(function (msg) {
  try {
    // üö´ IGNORE handshake / system messages
    if (msg && typeof msg === "object" && !("payload" in msg)) return;

    firstMessageReceived = true;
    if (readyPingerId) {
      clearInterval(readyPingerId);
      readyPingerId = null;
    }

    setTimeout(() => {
      const payload =
        msg && typeof msg === "object" && "payload" in msg
          ? msg.payload
          : msg;

      if (typeof payload !== "string") return; // üî• PREVENT [object Object]

      safeRender(payload);
    }, 50);

  } catch (err) {
    outEl.textContent = "Render error:" + err;
  }
});

    function pingReady(){
      try{ThunkableWebviewerExtension.postMessage('ready');}
      catch(e){debug('postMessage error:'+e);}
    }
    window.addEventListener('DOMContentLoaded',()=>{
      pingReady();
      let tries=0;
      readyPingerId=setInterval(()=>{
        if(firstMessageReceived||tries>=10){clearInterval(readyPingerId);readyPingerId=null;return;}
        pingReady();tries++;
      },600);
    });

    // ‚úÖ Universal Copy handler
copyBtn.onclick = () => {
  const html = (lastSingleAnswer || "").trim();
  if (!html) {
    alert("No response yet to copy.");
    return;
  }

  // Create temporary DOM parser
  const tempDiv = document.createElement("div");
  tempDiv.innerHTML = html;

  // Convert <a> tags ‚Üí Markdown [label](url)
  tempDiv.querySelectorAll("a[href]").forEach(a => {
    const label = a.textContent.trim();
    const url = a.href.trim();
    const md = `[${label}](${url})`;
    a.replaceWith(document.createTextNode(md));
  });

  // Extract readable text without any HTML tags
  const text = tempDiv.innerText
    .replace(/\n{3,}/g, "\n\n")
    .trim();

  try {
    navigator.clipboard.writeText(text).then(() => {
      copyBtn.textContent = "Copied!";
      setTimeout(() => (copyBtn.textContent = "Copy Last Answer"), 1500);
    });
  } catch (err) {
    // iOS fallback
    const t = document.createElement("textarea");
    t.value = text;
    t.style.position = "fixed";
    t.style.opacity = "0";
    document.body.appendChild(t);
    t.select();
    document.execCommand("copy");
    document.body.removeChild(t);

    copyBtn.textContent = "Copied!";
    setTimeout(() => (copyBtn.textContent = "Copy Last Answer"), 1500);
  }
};
    
    followupBtn.onclick = async () => {
      const q = followupText.value.trim();
      if (!q) return;
window.lastUserQuestion = window.lastQuestion || "";
window.lastQuestion = q;
      loading.style.display = 'block';
      followupBtn.disabled = true;
      try {
const res = await fetch('https://servicecanbackendproduction-production.up.railway.app/ask', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    question: q,
    previousQuestion: window.lastUserQuestion || ""
  })
});
        const data = await res.json();
        safeRender(data.answer || '(no response)');
      } catch (err) {
        safeRender('‚ö†Ô∏è Error sending follow-up: ' + err.message);
      }
      loading.style.display = 'none';
      followupBtn.disabled = false;
      followupText.value = '';
    };

</script>

<!-- ===========================================
     IN-APP OVERLAY BROWSER FOR SERVICE CANADA
     =========================================== -->
<style>
#sc-browser-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: white;
  z-index: 99999;
  display: none;
}

#sc-browser-frame {
  width: 100%;
  height: 100%;
  border: none;
}
</style>

<!-- === COMPAiSS PREMIUM FORMATTING ‚Äî CSS ONLY (SAFE FOR ALL APPS) === -->
<style>

/* --- FIX: Prevent iOS clipping of numbered lists and bullets --- */
#out {
  padding-left: 8px !important;     /* Ensures list markers are never clipped */
}

/* Lists (merged fix + spacing rules) */
#out ol,
#out ul {
  padding-left: 1.4em !important;   /* Enough space for iOS list markers */
  margin-left: 0 !important;        /* Prevent negative browser margin */
  margin-top: 0.3em;
  margin-bottom: 0.8em;
}

#out li {
  padding-left: 2px;                /* Micro-indent for safety */
  margin-bottom: 0.25em;
  line-height: 1.4;
}

/* Paragraph spacing & readability */
#out p {
  margin-top: 0.6em;
  margin-bottom: 0.6em;
  line-height: 1.45;
}

/* Clean branded hyperlinks */
#out a {
color: #0645AD;   /* standard web blue */
  text-decoration: underline;
  font-weight: 500;
}
#out a:hover {
  opacity: 0.85;
}

/* Elegant blockquotes for policy quotations */
#out blockquote {
  border-left: 4px solid var(--accent);
  padding-left: 12px;
  margin-left: 0;
  margin-top: 0.6em;
  margin-bottom: 0.6em;
  color: #555;
  font-style: italic;
}
  
</style>

<script>
/* ===============================
   SERVICE CANADA INTRO CONTROL
   Step 1: Show intro ‚Üí fade ‚Üí reveal app
=============================== */

document.addEventListener("DOMContentLoaded", () => {
  const intro = document.getElementById("sc-intro");
  const continueBtn = document.getElementById("sc-intro-continue");
  const app = document.getElementById("app-root");

  if (!intro || !continueBtn || !app) return;

  // Ensure intro is visible and app is hidden on load
  intro.classList.remove("hidden");
  app.classList.remove("visible");

  continueBtn.addEventListener("click", () => {
    intro.classList.add("hidden");

    setTimeout(() => {
      intro.style.display = "none";
      app.classList.add("visible");
    }, 400); // must match CSS transition
  });
});
</script>
  
</body>
</html>
